FROM php:8.2-apache

RUN echo "<Directory /var/www/html>" > /etc/apache2/conf-available/security.conf && \
    echo "    Options -Indexes" >> /etc/apache2/conf-available/security.conf && \
    echo "    RewriteEngine On" >> /etc/apache2/conf-available/security.conf && \
    echo "    RewriteRule ^filter\.php$ - [R=404,L]" >> /etc/apache2/conf-available/security.conf && \
    echo "</Directory>" >> /etc/apache2/conf-available/security.conf && \
    a2enconf security && \
    a2enmod rewrite

RUN echo "disable_functions = highlight_file,show_source,print_r,var_dump,file_get_contents,echo,readfile,system,exec,shell_exec,passthru" > /usr/local/etc/php/conf.d/custom-php.ini && \
    echo "auto_prepend_file = /var/www/html/filter.php" >> /usr/local/etc/php/conf.d/custom-php.ini

WORKDIR /var/www/html
COPY index.php .
COPY flag.php .
COPY filter.php .

RUN chown -R www-data:www-data /var/www/html && \
    chmod -R 755 /var/www/html && \
    chmod 755 /

RUN echo '#!/bin/bash' > /entrypoint.sh && \
    echo 'echo "$GZCTF_FLAG" > /flag9527.txt' >> /entrypoint.sh && \
    echo 'chmod 755 /flag9527.txt' >> /entrypoint.sh && \
    echo 'exec apache2-foreground' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

EXPOSE 80
ENTRYPOINT ["/entrypoint.sh"]
