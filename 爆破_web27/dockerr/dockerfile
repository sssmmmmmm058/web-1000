FROM php:8.2-apache

# 清除默认源，仅保留阿里云源（避免deb.debian.org解析失败）
RUN echo '' > /etc/apt/sources.list && \
    echo 'deb http://mirrors.aliyun.com/debian/ bullseye main non-free contrib' >> /etc/apt/sources.list && \
    echo 'deb-src http://mirrors.aliyun.com/debian/ bullseye main non-free contrib' >> /etc/apt/sources.list && \
    echo 'deb http://mirrors.aliyun.com/debian-security/ bullseye-security main' >> /etc/apt/sources.list && \
    echo 'deb-src http://mirrors.aliyun.com/debian-security/ bullseye-security main' >> /etc/apt/sources.list && \
    echo 'deb http://mirrors.aliyun.com/debian/ bullseye-updates main non-free contrib' >> /etc/apt/sources.list && \
    echo 'deb-src http://mirrors.aliyun.com/debian/ bullseye-updates main non-free contrib' >> /etc/apt/sources.list

# 安装必要依赖（移除libapache2-mod-php，基础镜像已自带）
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*

# 安装Python库
RUN pip3 install pandas openpyxl

# 启用Apache模块
RUN a2enmod rewrite

# 创建安全目录结构
RUN mkdir -p /var/www/data /var/www/scripts /var/www/html && \
    chown -R www-data:www-data /var/www && \
    chmod 700 /var/www/data  # 仅所有者可访问

# 复制项目文件
COPY process_excel.py /var/www/scripts/
COPY address.json /var/www/data/
COPY list.xlsx /var/www/data/
COPY *.php /var/www/html/

# 修复Apache安全配置（仅禁止敏感目录访问，移除非法配置）
RUN echo 'Options -Indexes' > /etc/apache2/conf-available/security.conf && \
    echo '<Directory /var/www/data/>' >> /etc/apache2/conf-available/security.conf && \
    echo '  Require all denied' >> /etc/apache2/conf-available/security.conf && \
    echo '</Directory>' >> /etc/apache2/conf-available/security.conf && \
    echo '<Directory /var/www/scripts/>' >> /etc/apache2/conf-available/security.conf && \
    echo '  Require all denied' >> /etc/apache2/conf-available/security.conf && \
    echo '</Directory>' >> /etc/apache2/conf-available/security.conf && \
    a2enconf security.conf

# 创建启动脚本（增加错误输出，方便调试）
RUN echo '#!/bin/bash' > /start.sh && \
    echo 'echo "开始处理Excel文件..."' >> /start.sh && \
    echo 'python3 /var/www/scripts/process_excel.py 2>&1 | tee /var/log/excel_process.log' >> /start.sh && \
    echo 'echo "启动Apache服务..."' >> /start.sh && \
    echo 'apache2-foreground' >> /start.sh && \
    chmod +x /start.sh

# 暴露端口
EXPOSE 80

# 启动容器
CMD ["/start.sh"]