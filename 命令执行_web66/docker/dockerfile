FROM php:8.2-apache

RUN echo "<Directory /var/www/html>" > /etc/apache2/conf-available/security.conf && \
    echo "    Options -Indexes" >> /etc/apache2/conf-available/security.conf && \
    # 启用Rewrite模块（用于URL重写返回404）
    echo "    RewriteEngine On" >> /etc/apache2/conf-available/security.conf && \
    # 匹配filter.php，强制返回404
    echo "    RewriteRule ^filter\.php$ - [R=404,L]" >> /etc/apache2/conf-available/security.conf && \
    echo "</Directory>" >> /etc/apache2/conf-available/security.conf && \
    a2enconf security && \
    a2enmod rewrite

# 配置PHP自动加载filter.php
RUN echo "auto_prepend_file = /var/www/html/filter.php" > /usr/local/etc/php/conf.d/auto-load.ini
RUN echo "disable_functions = system,exec,shell_exec,passthru" > /usr/local/etc/php/conf.d/custom-php.ini

# 工作目录 + 复制所有文件
WORKDIR /var/www/html
COPY index.php .
COPY flag.php .
COPY filter.php .

# 宽松权限
RUN chown -R www-data:www-data /var/www/html && \
    chmod -R 755 /var/www/html && \
    chmod 755 /

# 写入flag到/flag.txt
RUN echo '#!/bin/bash' > /entrypoint.sh && \
    echo 'echo "$GZCTF_FLAG" > /flag.txt' >> /entrypoint.sh && \
    echo 'chmod 755 /flag.txt' >> /entrypoint.sh && \
    echo 'exec apache2-foreground' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

EXPOSE 80
ENTRYPOINT ["/entrypoint.sh"]
